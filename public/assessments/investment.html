<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' https://pagead2.googlesyndication.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self';
      connect-src 'self';
      frame-src https://pagead2.googlesyndication.com
    ">
    <title>íˆ¬ì ì„±í–¥ ë¶„ì„ - PersonaHub</title>
    <link rel="stylesheet" href="/common.css">
    <link rel="stylesheet" href="/css/assessments.css">
</head>
<body>
    <div class="container">
        <!-- ì§„í–‰ í‘œì‹œì¤„ -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="currentQ">1</span> / <span id="totalQ">10</span>
            </div>
        </div>

        <!-- ì§ˆë¬¸ ì˜ì—­ -->
        <div class="question-card fade-in" id="questionCard">
            <h2 class="question-text" id="questionText"></h2>
            <div class="options-container" id="optionsContainer">
                <!-- ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="nav-buttons">
            <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" disabled>â† ì´ì „</button>
            <button class="btn btn-ghost" id="skipBtn" onclick="skipQuestion()">ê±´ë„ˆë›°ê¸°</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">ë‹¤ìŒ â†’</button>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div class="result-container hidden" id="resultContainer">
            <div class="result-card">
                <div class="result-emoji" id="resultEmoji"></div>
                <h2 class="result-type" id="resultType"></h2>
                <h3 class="result-title" id="resultTitle"></h3>
                <p class="result-description" id="resultDescription"></p>

                <div class="score-display">
                    <h4>ğŸ“Š ì ìˆ˜</h4>
                    <div class="score-value" id="scoreValue"></div>
                    <p class="score-range">/ 50</p>
                </div>

                <div class="strengths-section">
                    <h4>ğŸ’ª ê°•ì </h4>
                    <div class="strengths-list" id="strengthsList"></div>
                </div>

                <div class="assets-section">
                    <h4>ğŸ’¼ ì¶”ì²œ ìì‚°</h4>
                    <div class="assets-list" id="assetsList"></div>
                </div>

                <div class="tips-section">
                    <h4>ğŸ’¡ íˆ¬ì íŒ</h4>
                    <p id="tipsText"></p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="shareResult()">ğŸ“¤ ê²°ê³¼ ê³µìœ </button>
                    <button class="btn btn-secondary" onclick="retakeAssessment()">ğŸ”„ ë‹¤ì‹œ ë¶„ì„</button>
                    <a href="/" class="btn btn-ghost">ğŸ  í—ˆë¸Œë¡œ ê°€ê¸°</a>
                </div>
            </div>
        </div>

        <!-- Google AdSense -->
        <section class="container" style="margin-top: 3rem;">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4896634202351610" crossorigin="anonymous"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4896634202351610"
                 data-ad-slot="5187796077"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </section>
    </div>

    <script src="/common.js"></script>
    <script src="/security.js"></script>
    <script src="/assessment-engine.js"></script>
    <script>
        // íˆ¬ì ì„±í–¥ ë¶„ì„ ì„¤ì •
        const ASSESSMENT_CONFIG = {
            id: 'investment',
            name: 'íˆ¬ì ì„±í–¥ ë¶„ì„',
            description: 'ë‹¹ì‹ ì˜ íˆ¬ì ì„±í–¥ì„ ë¶„ì„í•©ë‹ˆë‹¤'
        };

        let questions = [];
        let types = {};
        let currentQuestion = 0;
        let answers = [];
        let totalScore = 0;

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            initAssessment();
        });

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                const [questions, types] = await Promise.all([
                    Security.loadAndValidate('/data/investment-questions.json', Security.validateQuestions),
                    Security.loadAndValidate('/data/investment-types.json', Security.validateTypes)
                ]);

                window.questions = questions;
                window.types = types;

                // ì´ ì§ˆë¬¸ ìˆ˜ í‘œì‹œ
                document.getElementById('totalQ').textContent = questions.length;
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
        }

        // ë¶„ì„ ì´ˆê¸°í™”
        function initAssessment() {
            currentQuestion = 0;
            answers = new Array(questions.length).fill(null);
            totalScore = 0;
            showQuestion(0);
            updateProgress();
        }

        // ì§ˆë¬¸ í‘œì‹œ
        function showQuestion(index) {
            const question = questions[index];
            const questionCard = document.getElementById('questionCard');
            const questionText = document.getElementById('questionText');
            const optionsContainer = document.getElementById('optionsContainer');

            // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
            questionCard.classList.remove('fade-in');
            void questionCard.offsetWidth; // reflow
            questionCard.classList.add('fade-in');

            // ì§ˆë¬¸ í…ìŠ¤íŠ¸
            questionText.textContent = question.question;

            // ì˜µì…˜ ìƒì„±
            optionsContainer.innerHTML = '';
            question.options.forEach((option, optIndex) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.textContent = option.text;
                optionBtn.onclick = () => selectOption(optIndex, option);
                optionsContainer.appendChild(optionBtn);
            });

            // í˜„ì¬ ì§ˆë¬¸ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            document.getElementById('currentQ').textContent = index + 1;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('skipBtn').classList.toggle('hidden', index === questions.length - 1);

            // ë§ˆì§€ë§‰ ì§ˆë¬¸ì´ë©´ ë‹¤ìŒ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const nextBtn = document.getElementById('nextBtn');
            if (index === questions.length - 1) {
                nextBtn.textContent = 'ê²°ê³¼ ë³´ê¸° â†’';
            } else {
                nextBtn.textContent = 'ë‹¤ìŒ â†’';
            }
        }

        // ì˜µì…˜ ì„ íƒ
        function selectOption(optIndex, option) {
            answers[currentQuestion] = { optIndex, option };

            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            totalScore = answers.reduce((sum, ans) => sum + (ans ? ans.option.value : 0), 0);

            // ì„ íƒëœ ì˜µì…˜ í•˜ì´ë¼ì´íŠ¸
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, idx) => {
                btn.classList.toggle('selected', idx === optIndex);
            });
        }

        // ë‹¤ìŒ ì§ˆë¬¸
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
            } else {
                showResult();
            }
        }

        // ì´ì „ ì§ˆë¬¸
        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // ì§ˆë¬¸ ê±´ë„ˆë›°ê¸°
        function skipQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // ê²°ê³¼ ê³„ì‚°
        function calculateResult() {
            // ì ìˆ˜ ë²”ìœ„ì— ë”°ë¥¸ ìœ í˜• ë§¤ì¹­
            const score = totalScore;
            let typeId;

            if (score <= 10) {
                typeId = 'conservative';
            } else if (score <= 20) {
                typeId = 'balanced';
            } else if (score <= 30) {
                typeId = 'growth';
            } else if (score <= 40) {
                typeId = 'aggressive';
            } else {
                typeId = 'speculative';
            }

            return { typeId, typeData: types[typeId], score };
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult() {
            const { typeId, typeData, score } = calculateResult();

            // ê²°ê³¼ ì¹´ë“œ ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('resultEmoji').textContent = typeData.emoji;
            document.getElementById('resultType').textContent = typeData.name;
            document.getElementById('resultTitle').textContent = typeData.title;
            document.getElementById('resultDescription').textContent = typeData.description;

            // ì ìˆ˜ í‘œì‹œ
            document.getElementById('scoreValue').textContent = score;

            // ê°•ì  ëª©ë¡
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = typeData.strengths.map(strength =>
                `<span class="strength-tag">${strength}</span>`
            ).join('');

            // ì¶”ì²œ ìì‚° ëª©ë¡
            const assetsList = document.getElementById('assetsList');
            assetsList.innerHTML = typeData.recommended_assets.map(asset =>
                `<span class="asset-tag">${asset}</span>`
            ).join('');

            // íˆ¬ì íŒ
            document.getElementById('tipsText').textContent = typeData.tips;

            // ì§ˆë¬¸ ì¹´ë“œ ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
            document.getElementById('questionCard').classList.add('hidden');
            document.querySelector('.nav-buttons').classList.add('hidden');
            document.querySelector('.progress-container').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');

            // ê²°ê³¼ ì €ì¥
            PersonaHub.saveResult({
                assessmentId: ASSESSMENT_CONFIG.id,
                assessmentName: ASSESSMENT_CONFIG.name,
                result: typeData.name,
                resultType: typeId,
                resultData: typeData,
                score: score,
                completedAt: new Date().toISOString()
            });
        }

        // ê²°ê³¼ ê³µìœ 
        function shareResult() {
            const { typeId, typeData } = calculateResult();

            const shareText = `ğŸ“ˆ ë‚´ íˆ¬ì ì„±í–¥ì€ ${typeData.name} ${typeData.emoji}\n${typeData.title}\n\në‹¹ì‹ ë„ ë¶„ì„í•´ë³´ì„¸ìš”! ğŸ‘‡`;
            const shareUrl = 'https://personahub.com/assessments/investment';

            PersonaHub.shareToClipboard(shareText, shareUrl);
        }

        // ë‹¤ì‹œ ë¶„ì„
        function retakeAssessment() {
            // ê²°ê³¼ ìˆ¨ê¸°ê³  ì§ˆë¬¸ í‘œì‹œ
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('questionCard').classList.remove('hidden');
            document.querySelector('.nav-buttons').classList.remove('hidden');
            document.querySelector('.progress-container').classList.remove('hidden');

            // ë¶„ì„ ì´ˆê¸°í™”
            initAssessment();
        }
    </script>
</body>
</html>
