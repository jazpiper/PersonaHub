<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' https://pagead2.googlesyndication.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self';
      connect-src 'self';
      frame-src https://pagead2.googlesyndication.com
    ">
    <title>MBTI ì„±ê²© ìœ í˜• ë¶„ì„ - PersonaHub</title>
    <link rel="stylesheet" href="/common.css">
    <link rel="stylesheet" href="/css/assessments.css">
</head>
<body>
    <div class="container">
        <!-- ì§„í–‰ í‘œì‹œì¤„ -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="currentQ">1</span> / <span id="totalQ">12</span>
            </div>
        </div>

        <!-- ì§ˆë¬¸ ì˜ì—­ -->
        <div class="question-card fade-in" id="questionCard">
            <h2 class="question-text" id="questionText"></h2>
            <div class="options-container" id="optionsContainer">
                <!-- ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="nav-buttons">
            <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" disabled>â† ì´ì „</button>
            <button class="btn btn-ghost" id="skipBtn" onclick="skipQuestion()">ê±´ë„ˆë›°ê¸°</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">ë‹¤ìŒ â†’</button>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div class="result-container hidden" id="resultContainer">
            <div class="result-card">
                <div class="result-emoji" id="resultEmoji"></div>
                <h2 class="result-type" id="resultType"></h2>
                <h3 class="result-title" id="resultTitle"></h3>
                <p class="result-description" id="resultDescription"></p>

                <div class="strengths-section">
                    <h4>ğŸ’ª ê°•ì </h4>
                    <div class="strengths-list" id="strengthsList"></div>
                </div>

                <div class="score-breakdown">
                    <h4>ğŸ“Š ì ìˆ˜ ë¶„ì„</h4>
                    <div class="dimension-bars" id="dimensionBars"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="shareResult()">ğŸ“¤ ê²°ê³¼ ê³µìœ </button>
                    <button class="btn btn-secondary" onclick="retakeAssessment()">ğŸ”„ ë‹¤ì‹œ ë¶„ì„</button>
                    <a href="/" class="btn btn-ghost">ğŸ  í—ˆë¸Œë¡œ ê°€ê¸°</a>
                </div>
            </div>
        </div>

        <!-- Google AdSense -->
        <section class="container" style="margin-top: 3rem;">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4896634202351610" crossorigin="anonymous"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4896634202351610"
                 data-ad-slot="5187796077"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </section>
    </div>

    <script src="/common.js"></script>
    <script src="/security.js"></script>
    <script src="/assessment-engine.js"></script>
    <script>
        // MBTI ë¶„ì„ ì„¤ì •
        const ASSESSMENT_CONFIG = {
            id: 'mbti',
            name: 'MBTI ì„±ê²© ìœ í˜• ë¶„ì„',
            description: 'ë‹¹ì‹ ì˜ ì„±ê²© ìœ í˜•ì„ ë¶„ì„í•©ë‹ˆë‹¤'
        };

        // MBTI ì°¨ì›
        const DIMENSIONS = {
            E: { opposite: 'I', name: 'ì™¸í–¥í˜• (E)', color: '#FF6B6B' },
            I: { opposite: 'E', name: 'ë‚´í–¥í˜• (I)', color: '#4ECDC4' },
            S: { opposite: 'N', name: 'ê°ê°í˜• (S)', color: '#45B7D1' },
            N: { opposite: 'S', name: 'ì§ê´€í˜• (N)', color: '#96CEB4' },
            T: { opposite: 'F', name: 'ì‚¬ê³ í˜• (T)', color: '#FFEAA7' },
            F: { opposite: 'T', name: 'ê°ì •í˜• (F)', color: '#DDA0DD' },
            J: { opposite: 'P', name: 'íŒë‹¨í˜• (J)', color: '#98D8C8' },
            P: { opposite: 'J', name: 'ì¸ì§€í˜• (P)', color: '#F7DC6F' }
        };

        let questions = [];
        let types = {};
        let currentQuestion = 0;
        let answers = [];
        let scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            initAssessment();
        });

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                const [questions, types] = await Promise.all([
                    Security.loadAndValidate('/data/mbti-questions.json', Security.validateQuestions),
                    Security.loadAndValidate('/data/mbti-types.json', Security.validateTypes)
                ]);

                window.questions = questions;
                window.types = types;

                // ì´ ì§ˆë¬¸ ìˆ˜ í‘œì‹œ
                document.getElementById('totalQ').textContent = questions.length;
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
        }

        // ë¶„ì„ ì´ˆê¸°í™”
        function initAssessment() {
            currentQuestion = 0;
            answers = new Array(questions.length).fill(null);
            scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            showQuestion(0);
            updateProgress();
        }

        // ì§ˆë¬¸ í‘œì‹œ
        function showQuestion(index) {
            const question = questions[index];
            const questionCard = document.getElementById('questionCard');
            const questionText = document.getElementById('questionText');
            const optionsContainer = document.getElementById('optionsContainer');

            // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
            questionCard.classList.remove('fade-in');
            void questionCard.offsetWidth; // reflow
            questionCard.classList.add('fade-in');

            // ì§ˆë¬¸ í…ìŠ¤íŠ¸
            questionText.textContent = question.question;

            // ì˜µì…˜ ìƒì„±
            optionsContainer.innerHTML = '';
            question.options.forEach((option, optIndex) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.textContent = option.text;
                optionBtn.onclick = () => selectOption(optIndex, option);
                optionsContainer.appendChild(optionBtn);
            });

            // í˜„ì¬ ì§ˆë¬¸ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            document.getElementById('currentQ').textContent = index + 1;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('skipBtn').classList.toggle('hidden', index === questions.length - 1);

            // ë§ˆì§€ë§‰ ì§ˆë¬¸ì´ë©´ ë‹¤ìŒ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const nextBtn = document.getElementById('nextBtn');
            if (index === questions.length - 1) {
                nextBtn.textContent = 'ê²°ê³¼ ë³´ê¸° â†’';
            } else {
                nextBtn.textContent = 'ë‹¤ìŒ â†’';
            }
        }

        // ì˜µì…˜ ì„ íƒ
        function selectOption(optIndex, option) {
            answers[currentQuestion] = { optIndex, option };

            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            scores[option.dimension] += option.value;

            // ì„ íƒëœ ì˜µì…˜ í•˜ì´ë¼ì´íŠ¸
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, idx) => {
                btn.classList.toggle('selected', idx === optIndex);
            });
        }

        // ë‹¤ìŒ ì§ˆë¬¸
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
            } else {
                showResult();
            }
        }

        // ì´ì „ ì§ˆë¬¸
        function prevQuestion() {
            if (currentQuestion > 0) {
                // í˜„ì¬ ë‹µë³€ ì œê±° (ë˜ëŒë¦¬ê¸°)
                const currentAnswer = answers[currentQuestion];
                if (currentAnswer) {
                    scores[currentAnswer.option.dimension] -= currentAnswer.option.value;
                }

                currentQuestion--;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // ì§ˆë¬¸ ê±´ë„ˆë›°ê¸°
        function skipQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // ê²°ê³¼ ê³„ì‚°
        function calculateResult() {
            const mbti = [];

            mbti.push(scores.E >= scores.I ? 'E' : 'I');
            mbti.push(scores.S >= scores.N ? 'S' : 'N');
            mbti.push(scores.T >= scores.F ? 'T' : 'F');
            mbti.push(scores.J >= scores.P ? 'J' : 'P');

            return mbti.join('');
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult() {
            const mbti = calculateResult();
            const typeData = types[mbti];

            // ê²°ê³¼ ì¹´ë“œ ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('resultEmoji').textContent = typeData.emoji;
            document.getElementById('resultType').textContent = `${mbti} - ${typeData.name}`;
            document.getElementById('resultTitle').textContent = typeData.title;
            document.getElementById('resultDescription').textContent = typeData.description;

            // ê°•ì  ëª©ë¡
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = typeData.strengths.map(strength =>
                `<span class="strength-tag">${strength}</span>`
            ).join('');

            // ì ìˆ˜ ë¶„ì„
            const dimensionBars = document.getElementById('dimensionBars');
            const pairs = [['E', 'I'], ['S', 'N'], ['T', 'F'], ['J', 'P']];

            dimensionBars.innerHTML = pairs.map(([d1, d2]) => {
                const score1 = scores[d1];
                const score2 = scores[d2];
                const total = score1 + score2;
                const percent1 = total > 0 ? (score1 / total) * 100 : 50;
                const percent2 = total > 0 ? (score2 / total) * 100 : 50;

                return `
                    <div class="dimension-bar">
                        <div class="dimension-bar-left" style="width: ${percent1}%; background-color: ${DIMENSIONS[d1].color}">
                            <span>${d1} ${Math.round(percent1)}%</span>
                        </div>
                        <div class="dimension-bar-right" style="width: ${percent2}%; background-color: ${DIMENSIONS[d2].color}">
                            <span>${d2} ${Math.round(percent2)}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            // ì§ˆë¬¸ ì¹´ë“œ ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
            document.getElementById('questionCard').classList.add('hidden');
            document.querySelector('.nav-buttons').classList.add('hidden');
            document.querySelector('.progress-container').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');

            // ê²°ê³¼ ì €ì¥
            PersonaHub.saveResult({
                assessmentId: ASSESSMENT_CONFIG.id,
                assessmentName: ASSESSMENT_CONFIG.name,
                result: mbti,
                resultData: typeData,
                scores: scores,
                completedAt: new Date().toISOString()
            });
        }

        // ê²°ê³¼ ê³µìœ 
        function shareResult() {
            const mbti = calculateResult();
            const typeData = types[mbti];

            const shareText = `ğŸ§  ë‚´ MBTI ìœ í˜•ì€ ${mbti} ${typeData.emoji}\n${typeData.title}\n\në‹¹ì‹ ë„ ë¶„ì„í•´ë³´ì„¸ìš”! ğŸ‘‡`;
            const shareUrl = 'https://personahub.com/assessments/mbti';

            PersonaHub.shareToClipboard(shareText, shareUrl);
        }

        // ë‹¤ì‹œ ë¶„ì„
        function retakeAssessment() {
            // ê²°ê³¼ ìˆ¨ê¸°ê³  ì§ˆë¬¸ í‘œì‹œ
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('questionCard').classList.remove('hidden');
            document.querySelector('.nav-buttons').classList.remove('hidden');
            document.querySelector('.progress-container').classList.remove('hidden');

            // ë¶„ì„ ì´ˆê¸°í™”
            initAssessment();
        }
    </script>
</body>
</html>
