<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' https://pagead2.googlesyndication.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self';
      connect-src 'self';
      frame-src https://pagead2.googlesyndication.com
    ">
    <title>ì—°ì•  ìœ í˜• ë¶„ì„ - PersonaHub</title>
    <link rel="stylesheet" href="/common.css">
    <link rel="stylesheet" href="/css/assessments.css">
</head>
<body>
    <div class="container">
        <!-- ì§„í–‰ í‘œì‹œì¤„ -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="currentQ">1</span> / <span id="totalQ">10</span>
            </div>
        </div>

        <!-- ì§ˆë¬¸ ì˜ì—­ -->
        <div class="question-card fade-in" id="questionCard">
            <h2 class="question-text" id="questionText"></h2>
            <div class="options-container" id="optionsContainer">
                <!-- ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="nav-buttons">
            <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" disabled>â† ì´ì „</button>
            <button class="btn btn-ghost" id="skipBtn" onclick="skipQuestion()">ê±´ë„ˆë›°ê¸°</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">ë‹¤ìŒ â†’</button>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div class="result-container hidden" id="resultContainer">
            <div class="result-card">
                <div class="result-emoji" id="resultEmoji"></div>
                <h2 class="result-type" id="resultType"></h2>
                <h3 class="result-title" id="resultTitle"></h3>
                <p class="result-description" id="resultDescription"></p>

                <div class="strengths-section">
                    <h4>ğŸ’ª ê°•ì </h4>
                    <div class="strengths-list" id="strengthsList"></div>
                </div>

                <div class="tips-section">
                    <h4>ğŸ’¡ ì—°ì•  íŒ</h4>
                    <p id="tipsText"></p>
                </div>

                <div class="score-breakdown">
                    <h4>ğŸ“Š ì ìˆ˜ ë¶„ì„</h4>
                    <div class="dimension-bars" id="dimensionBars"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="shareResult()">ğŸ“¤ ê²°ê³¼ ê³µìœ </button>
                    <button class="btn btn-secondary" onclick="retakeAssessment()">ğŸ”„ ë‹¤ì‹œ ë¶„ì„</button>
                    <a href="/" class="btn btn-ghost">ğŸ  í—ˆë¸Œë¡œ ê°€ê¸°</a>
                </div>
            </div>
        </div>

        <!-- Google AdSense -->
        <section class="container" style="margin-top: 3rem;">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4896634202351610" crossorigin="anonymous"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4896634202351610"
                 data-ad-slot="5187796077"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </section>
    </div>

    <script src="/common.js"></script>
    <script src="/security.js"></script>
    <script src="/assessment-engine.js"></script>
    <script>
        // ì—°ì•  ìœ í˜• ë¶„ì„ ì„¤ì •
        const ASSESSMENT_CONFIG = {
            id: 'love-type',
            name: 'ì—°ì•  ìœ í˜• ë¶„ì„',
            description: 'ë‹¹ì‹ ì˜ ì—°ì•  ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•©ë‹ˆë‹¤'
        };

        // ì—°ì•  ìœ í˜• ì°¨ì›
        const DIMENSIONS = {
            'idealism_vs_pragmatism': {
                name: 'ì´ìƒí˜•',
                a: { key: 'idealism', name: 'ë‚­ë§Œ', color: '#E74C3C' },
                b: { key: 'pragmatism', name: 'í˜„ì‹¤', color: '#3498DB' }
            },
            'emotion_vs_rationality': {
                name: 'ê°ˆë“± í•´ê²°',
                a: { key: 'emotion', name: 'ê°ì •', color: '#E91E63' },
                b: { key: 'rationality', name: 'ì´ì„±', color: '#9C27B0' }
            },
            'independence_vs_dependence': {
                name: 'ì¼ìƒ ìŠ¤íƒ€ì¼',
                a: { key: 'independence', name: 'ë…ë¦½', color: '#2196F3' },
                b: { key: 'dependence', name: 'í˜‘ë ¥', color: '#F48FB1' }
            },
            'adventure_vs_stability': {
                name: 'ê´€ê³„ ì„±í–¥',
                a: { key: 'adventure', name: 'ëª¨í—˜', color: '#FF9800' },
                b: { key: 'stability', name: 'ì•ˆì •', color: '#4CAF50' }
            },
            'curiosity_vs_loyalty': {
                name: 'íƒí—˜ ìœ í˜•',
                a: { key: 'curiosity', name: 'í˜¸ê¸°ì‹¬', color: '#FFEB3B' },
                b: { key: 'loyalty', name: 'ì¶©ì‹¤', color: '#607D8B' }
            }
        };

        let questions = [];
        let types = {};
        let currentQuestion = 0;
        let answers = [];
        let scores = {
            idealism: 0, pragmatism: 0,
            emotion: 0, rationality: 0,
            independence: 0, dependence: 0,
            adventure: 0, stability: 0,
            curiosity: 0, loyalty: 0
        };

        // í˜ì´ì§€ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            initAssessment();
        });

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                const [questions, types] = await Promise.all([
                    Security.loadAndValidate('/data/love-type-questions.json', Security.validateQuestions),
                    Security.loadAndValidate('/data/love-type-types.json', Security.validateTypes)
                ]);

                window.questions = questions;
                window.types = types;

                // ì´ ì§ˆë¬¸ ìˆ˜ í‘œì‹œ
                document.getElementById('totalQ').textContent = questions.length;
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            }
        }

        // ë¶„ì„ ì´ˆê¸°í™”
        function initAssessment() {
            currentQuestion = 0;
            answers = new Array(questions.length).fill(null);
            scores = {
                idealism: 0, pragmatism: 0,
                emotion: 0, rationality: 0,
                independence: 0, dependence: 0,
                adventure: 0, stability: 0,
                curiosity: 0, loyalty: 0
            };
            showQuestion(0);
            updateProgress();
        }

        // ì§ˆë¬¸ í‘œì‹œ
        function showQuestion(index) {
            const question = questions[index];
            const questionCard = document.getElementById('questionCard');
            const questionText = document.getElementById('questionText');
            const optionsContainer = document.getElementById('optionsContainer');

            // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
            questionCard.classList.remove('fade-in');
            void questionCard.offsetWidth; // reflow
            questionCard.classList.add('fade-in');

            // ì§ˆë¬¸ í…ìŠ¤íŠ¸
            questionText.textContent = question.question;

            // ì˜µì…˜ ìƒì„±
            optionsContainer.innerHTML = '';
            question.options.forEach((option, optIndex) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.textContent = option.text;
                optionBtn.onclick = () => selectOption(optIndex, option);
                optionsContainer.appendChild(optionBtn);
            });

            // í˜„ì¬ ì§ˆë¬¸ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            document.getElementById('currentQ').textContent = index + 1;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('skipBtn').classList.toggle('hidden', index === questions.length - 1);

            // ë§ˆì§€ë§‰ ì§ˆë¬¸ì´ë©´ ë‹¤ìŒ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const nextBtn = document.getElementById('nextBtn');
            if (index === questions.length - 1) {
                nextBtn.textContent = 'ê²°ê³¼ ë³´ê¸° â†’';
            } else {
                nextBtn.textContent = 'ë‹¤ìŒ â†’';
            }
        }

        // ì˜µì…˜ ì„ íƒ
        function selectOption(optIndex, option) {
            answers[currentQuestion] = { optIndex, option };

            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            scores[option.value]++;

            // ì„ íƒëœ ì˜µì…˜ í•˜ì´ë¼ì´íŠ¸
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, idx) => {
                btn.classList.toggle('selected', idx === optIndex);
            });
        }

        // ë‹¤ìŒ ì§ˆë¬¸
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
            } else {
                showResult();
            }
        }

        // ì´ì „ ì§ˆë¬¸
        function prevQuestion() {
            if (currentQuestion > 0) {
                // í˜„ì¬ ë‹µë³€ ì œê±° (ë˜ëŒë¦¬ê¸°)
                const currentAnswer = answers[currentQuestion];
                if (currentAnswer) {
                    scores[currentAnswer.option.value]--;
                }

                currentQuestion--;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // ì§ˆë¬¸ ê±´ë„ˆë›°ê¸°
        function skipQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // ê²°ê³¼ ê³„ì‚°
        function calculateResult() {
            const result = {};

            // ê° ì°¨ì›ì˜ ìš°ì„¸í•œ ìª½ ì„ íƒ
            result.idealism_vs_pragmatism = scores.idealism >= scores.pragmatism ? 'idealism' : 'pragmatism';
            result.emotion_vs_rationality = scores.emotion >= scores.rationality ? 'emotion' : 'rationality';
            result.independence_vs_dependence = scores.independence >= scores.dependence ? 'independence' : 'dependence';
            result.adventure_vs_stability = scores.adventure >= scores.stability ? 'adventure' : 'stability';
            result.curiosity_vs_loyalty = scores.curiosity >= scores.loyalty ? 'curiosity' : 'loyalty';

            // mbti_likeì™€ ì¼ì¹˜í•˜ëŠ” ìœ í˜• ì°¾ê¸°
            const mbtiLike = [
                result.idealism_vs_pragmatism.charAt(0).toUpperCase() === 'I' ? 'I' : 'P',
                result.emotion_vs_rationality.charAt(0).toUpperCase() === 'E' ? 'E' : 'R',
                result.independence_vs_dependence.charAt(0).toUpperCase() === 'I' ? 'I' : 'D',
                result.adventure_vs_stability.charAt(0).toUpperCase() === 'A' ? 'A' : 'S',
                result.curiosity_vs_loyalty.charAt(0).toUpperCase() === 'C' ? 'C' : 'L'
            ].join('-');

            // ìœ í˜• ì°¾ê¸°
            const matchingType = Object.entries(types).find(([id, type]) => {
                const typeCode = type.mbti_like || '';
                const normalizedCode = typeCode.replace(/-/g, '');
                const normalizedResult = mbtiLike.replace(/-/g, '');
                return normalizedCode === normalizedResult;
            });

            if (matchingType) {
                return { typeId: matchingType[0], typeData: matchingType[1] };
            }

            // ì¼ì¹˜í•˜ëŠ” ìœ í˜•ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
            return { typeId: 'balanced_lover', typeData: types['balanced_lover'] };
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult() {
            const { typeId, typeData } = calculateResult();

            // ê²°ê³¼ ì¹´ë“œ ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('resultEmoji').textContent = typeData.emoji;
            document.getElementById('resultType').textContent = `${typeData.name}`;
            document.getElementById('resultTitle').textContent = typeData.title;
            document.getElementById('resultDescription').textContent = typeData.description;

            // ê°•ì  ëª©ë¡
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = typeData.strengths.map(strength =>
                `<span class="strength-tag">${strength}</span>`
            ).join('');

            // ì—°ì•  íŒ
            document.getElementById('tipsText').textContent = typeData.tips;

            // ì ìˆ˜ ë¶„ì„
            const dimensionBars = document.getElementById('dimensionBars');
            const dimensionEntries = Object.entries(DIMENSIONS);

            dimensionBars.innerHTML = dimensionEntries.map(([key, dimension]) => {
                const scoreA = scores[dimension.a.key];
                const scoreB = scores[dimension.b.key];
                const total = scoreA + scoreB;
                const percentA = total > 0 ? (scoreA / total) * 100 : 50;
                const percentB = total > 0 ? (scoreB / total) * 100 : 50;

                return `
                    <div class="dimension-bar">
                        <div class="dimension-bar-left" style="width: ${percentA}%; background-color: ${dimension.a.color}">
                            <span>${dimension.a.name} ${Math.round(percentA)}%</span>
                        </div>
                        <div class="dimension-bar-right" style="width: ${percentB}%; background-color: ${dimension.b.color}">
                            <span>${dimension.b.name} ${Math.round(percentB)}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            // ì§ˆë¬¸ ì¹´ë“œ ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
            document.getElementById('questionCard').classList.add('hidden');
            document.querySelector('.nav-buttons').classList.add('hidden');
            document.querySelector('.progress-container').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');

            // ê²°ê³¼ ì €ì¥
            PersonaHub.saveResult({
                assessmentId: ASSESSMENT_CONFIG.id,
                assessmentName: ASSESSMENT_CONFIG.name,
                result: typeData.name,
                resultType: typeId,
                resultData: typeData,
                scores: scores,
                completedAt: new Date().toISOString()
            });
        }

        // ê²°ê³¼ ê³µìœ 
        function shareResult() {
            const { typeId, typeData } = calculateResult();

            const shareText = `ğŸ’• ë‚´ ì—°ì•  ìœ í˜•ì€ ${typeData.name} ${typeData.emoji}\n${typeData.title}\n\në‹¹ì‹ ë„ ë¶„ì„í•´ë³´ì„¸ìš”! ğŸ‘‡`;
            const shareUrl = 'https://personahub.com/assessments/love-type';

            PersonaHub.shareToClipboard(shareText, shareUrl);
        }

        // ë‹¤ì‹œ ë¶„ì„
        function retakeAssessment() {
            // ê²°ê³¼ ìˆ¨ê¸°ê³  ì§ˆë¬¸ í‘œì‹œ
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('questionCard').classList.remove('hidden');
            document.querySelector('.nav-buttons').classList.remove('hidden');
            document.querySelector('.progress-container').classList.remove('hidden');

            // ë¶„ì„ ì´ˆê¸°í™”
            initAssessment();
        }
    </script>
</body>
</html>
